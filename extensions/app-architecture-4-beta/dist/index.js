"use strict";var e;!function(e){e[e.Unknown=0]="Unknown",e[e.SimpleController=1]="SimpleController",e[e.DOMInstanceController=2]="DOMInstanceController",e[e.EmbeddedInstancesController=3]="EmbeddedInstancesController",e[e.Service=4]="Service",e[e.SimpleFunctionalController=5]="SimpleFunctionalController",e[e.DOMInstanceFunctionalController=6]="DOMInstanceFunctionalController"}(e||(e={}));class t{#e;#t;#r;constructor(e){this.#t=e,this.#e={vendors:[]},this.#r={};const t=e.getConfig("vendorLoader");if(t)this.#e={...this.#e,...t};else if(!1===t)return;e.subscribe("AppServicesInit",(()=>this.#i()))}#i(){this.#r=this.#e.vendors.reduce(((e,t)=>(e[t.uniqueName]={...t,requested:!1,loaded:!1},e)),{}),this.#e.vendors.forEach((e=>{this.#n(e)}))}requestVendorLoad(e,t=()=>{}){const r=this.#r[e];r?r.loaded?t():(r.requested=!0,this.#n(r),window.addEventListener(r.loadEventName??`VendorLoader_${e}_Load`,t)):this.#t.reportError(`No vendor with unique name "${e}" found.`,null)}#o(e){return e.conflictTriggerClass?.reduce(((e,t)=>e||document.getElementsByClassName(t).length>0),!1)??!1}#n(e){if(!this.#o(e)){const t=[...document.getElementsByClassName(e.triggerClass)];t.length>0&&!e.lazyLoad||e.requested?this.#s(e):t.length>0&&e.lazyLoad&&!e.requested&&this.#t.V(t).onViewportVisibleOnce((()=>{this.#s(e)}),{root:null,rootMargin:"0px",threshold:.1})}}#s(e){const{V:t}=this.#t,r=()=>{this.#t.logOnDebug(`🧱 Vendor ${e.scriptPath} ${e.requested?"loaded by request.":`loaded ${e.lazyLoad?"lazy":""} by CSS class trigger.`}`,!1),this.#t.emit(`${e.uniqueName}VendorLoad`),t(window).dispatchEvent(e.loadEventName??`VendorLoader_${e.uniqueName}_Load`),e.loaded=!0};document.getElementById(`${e.triggerClass}-script`)||t(document.head).addScriptFile(e.scriptPath,r,`${e.triggerClass}-script`)}}class r{#e;#l;#a;#t;constructor(e){this.#t=e,this.#a="",this.#e={loadImagesOnViewportVisible:!0,forceImageToHaveDomain:!0,viewportMobileSizes:["xs","sm"],viewportSizesMapping:()=>window.innerWidth<=575?"xs":window.innerWidth<=991?"sm":window.innerWidth<=1199?"md":window.innerWidth<=1399?"lg":"xl"};const t=e.getConfig("imageLoader");if(t)this.#e={...this.#e,...t};else if(!1===t)return;e.subscribe("AppServicesInit",(()=>this.#i()))}#i(){this.#c(),this.#p(),this.#e.loadImagesOnViewportVisible?this.#h():this.#d(),this.#u()}#d(){this.#l.forEach((e=>this.loadLazyElement(e)))}#h(){const{V:e}=this.#t;e(this.#l.filter((e=>!e.activeVisibilityTracking)).map((e=>(e.activeVisibilityTracking=!0,e)))).onViewportVisibleOnce((e=>{e.activeVisibilityTracking=!1,this.loadLazyElement(e)}),{root:null,rootMargin:"0px",threshold:.1})}#p(){this.#a=this.#g(),this.#t.setContextVar("viewportPredefinedSize",this.#a,!0),this.#t.setContextVar("isViewportSizeMobile",this.#e.viewportMobileSizes.includes(this.#a),!0)}#c(){this.#l=[...document.body.querySelectorAll("[data-image-src]")]}#m(e,t){return(this.#e.forceImageToHaveDomain?new URL(e,document.baseURI):new URL(e)).toString()}#v(e,t){if("xl"!==this.#a){const t=e.getAttribute(`data-src-${this.#a}`);if(t)return t}return t}#g(){return this.#e.viewportSizesMapping()}#I(e,t=e=>{}){let r=e;e.startsWith("/")&&(r=`${document.location.origin}${e}`),fetch(r).then((e=>e.text())).then((e=>{t(e)})).catch((t=>{console.error(`Cannot render SVG from ${e}`),console.error(t)}))}#b(e){const t=document.createElement("div");t.innerHTML=e;[...t.getElementsByTagName("script")].forEach((e=>{e.parentNode.removeChild(e)}));return t.getElementsByTagName("svg")[0]??null}#u(){const{V:e}=this.#t;e(window).onEvent("resize",(()=>{const e=this.#g();e!==this.#a&&(this.#a=e,this.#t.setContextVar("viewportPredefinedSize",this.#a,!0),this.#t.setContextVar("isViewportSizeMobile",this.#e.viewportMobileSizes.includes(this.#a),!0),this.#e.loadImagesOnViewportVisible?this.#h():this.#d())}))}loadLazyElement(e){const{V:t}=this.#t,r=e.getAttribute("data-image-src");if(!r)return void e.removeAttribute("data-image-src");const i=this.#m(this.#v(e,r),e);switch(e.tagName){case"IMG":e.setAttribute("src",i),t(e).hasClass("load-feedback")&&t(e).onEvent("load",(()=>{e.classList.add("img-loaded")}));break;case"DIV":(t(e).hasClass("parent-background-image")?e.parentNode:e).style.backgroundImage=`url("${i}")`;break;case"svg":this.#I(i,(t=>{const r=this.#b(t);if(r){const t=e.lazyloadCallback;if(!!!r.getAttribute("viewBox")){const e=r.getAttribute("height"),t=r.getAttribute("width");e&&t&&r.setAttribute("viewBox",`0 0 ${t} ${e}`)}e.classList.forEach((e=>{r.classList.add(e)})),e.parentNode.replaceChild(r,e),t&&t(r)}}));break;default:this.#t.reportError("Unsupported DOM element",e)}}}class i{#C;#A;#e;#S;#f;#E;#w;#V;#$;#t;#D;#M;#O;constructor(e,t){this.#C="4.0.4 beta",this.#A=e.id,this.#e=e.config,this.#$=t,this.#D=this.#y(),this.#t=this.#q(),this.#p(e),this.#w={},this.#f={},this.#E={},this.#S={},this.#V={},this.#M={appInitTime:null,appBeforeInitEventFired:!1,appInitEventFired:!1,appServicesInitEventSubscribedControllers:new Set,appServicesInitEventCompletedControllers:new Set}}debug(){return{services:this.#E,controllers:this.#S,data:this.#M}}getUniqueId(){return this.#A.uniqueId}getBuildNumber(){return this.#A.buildNumber}#p(e){const t={alias:"isAppInDebugMode",value:this.#D,readOnly:!0};this.#O=e.contextVars??{},this.#O[t.alias]=t}#q(){const t={getController:this.getController.bind(this),getCurrentCulture:this.getCulture.bind(this),getService:this.getService.bind(this),getInstanceController:this.getInstanceController.bind(this),getInstanceControllerById:this.getInstanceControllerById.bind(this),getConfig:this.getConfig.bind(this),V:(e=null)=>this.#$.setTarget(e),V$:(e=null)=>this.#$.setTarget(document.querySelectorAll(e)),logOnDebug:()=>{},warnOnDebug:()=>{},reportError:()=>{},whoIam:()=>({aliasOrId:"I don't know...",type:e.Unknown}),subscribe:this.#L.bind(this),subscribeToAll:()=>{},useVendor:()=>{},emit:()=>{},getContextVar:()=>{},setContextVar:()=>{},getRootDOMElement:()=>document.documentElement};return this.#$.makeInmutable(t),t}#y(){return!!localStorage.getItem("JSVHAppArchitectureDebug")}getCulture(){return this.#e.culture??""}getConfig(e){return this.#e.custom[e]??null}registerSimpleController(e="",t,r){e&&t?this.#S[e]||this.#f[e]||this.#E[e]||this.#w[e]?console.error(`AppArchitecture: Unable to register controller, "${e}" is already registered.`):r?.generateInstanceBeforeInit?this.#R(e,t):this.#f[e]={uniqueAlias:e,controllerClass:t,controllerFunction:null}:console.error(`AppArchitecture: Unable to register controller, unique alias (${e}) and controllerClass are expected parameters.`)}registerFunctionalSimpleController(e="",t,r){e&&t?this.#S[e]||this.#f[e]||this.#E[e]||this.#w[e]?console.error(`AppArchitecture: Unable to register controller, "${e}" is already registered.`):r?.generateInstanceBeforeInit?this.#x(e,t):this.#f[e]={uniqueAlias:e,controllerClass:null,controllerFunction:t}:console.error(`AppArchitecture: Unable to register controller, unique alias (${e}) and controllerFunction are expected parameters.`)}registerService(e="",t,r){e&&t?this.#S[e]||this.#f[e]||this.#E[e]||this.#w[e]?console.error(`AppArchitecture: Unable to register service, "${e}" is already registered.`):this.#z(e,t):console.error(`AppArchitecture: Unable to register service, unique alias (${e}) and serviceControllerClass are expected parameters.`)}registerInstancesController(e="",t,r){e&&t?this.#S[e]||this.#f[e]||this.#E[e]||this.#w[e]?console.error(`AppArchitecture: Unable to register instances controller, "${e}" is already registered.`):this.#S[e]=new n(e,t,null):console.error(`AppArchitecture: Unable to register instances controller, unique alias (${e}) and instanceControllerClass are expected parameters.`)}registerFunctionalInstancesController(e="",t,r){e&&t?this.#S[e]||this.#f[e]||this.#E[e]||this.#w[e]?console.error(`AppArchitecture: Unable to register instances controller, "${e}" is already registered.`):this.#S[e]=new n(e,null,t):console.error(`AppArchitecture: Unable to register instances controller, unique alias (${e}) and instanceControllerFunction are expected parameters.`)}#H(e){this.#D?(e.style.opacity="0.6",e.style.filter="grayscale(100%)",e.prepend("⚠️")):this.#e.errorManagement?.hideCrashedDOMInstancesDuringInit&&(e.style.display="none")}#F(e,t){this.#$.console("error",`AppArchitecture: 🤕 An unexpected error happened in the inline init of DOM instance component "${e.id?e.id:"-NO ID-"}"`),this.#$.console("error",e),this.#$.console("error",t),this.#H(e)}#T(){const e=(e,t)=>{const r=t.createComponentInstance(e,this.#N.bind(this));this.#V[r.uniqueId]?this.#F(e,`DOM Instance id "${r.uniqueId}" is not unique.`):this.#V[r.uniqueId]=r};[...document.querySelectorAll("[jsvh-controller]")].forEach((t=>{const r=t.getAttribute("jsvh-controller"),i=t.getAttribute("jsvh-modular-controller-src"),n=this.#S[r];if(!n&&!i)return this.#$.console("error",`AppArchitecture: Instances controller "${r}" is not registered in the webapp.`),void this.#$.console("error",t);if(!n&&i)try{this.#$.addScriptFile(i,(()=>{const i=this.#S[r];if(!i)return this.#$.console("error",`AppArchitecture: Modular instances controller "${r}" is not registered in the webapp.`),void this.#$.console("error",t);e(t,i)}),`${r}-script`,document.head)}catch(e){this.#F(t,e)}else e(t,n)}))}#U(){return new Promise(((e,t)=>{0===this.#M.appServicesInitEventSubscribedControllers.size?e():(this.#L("AppServicesInit%",((t,r)=>{this.#E[r]&&(this.#M.appServicesInitEventCompletedControllers.add(r),this.#M.appServicesInitEventCompletedControllers.size===this.#M.appServicesInitEventSubscribedControllers.size&&e())})),this.#L("AppServicesInit/",((e,r)=>{this.#E[r]&&t()})))}))}#B(e,t,r){switch(e){case"AppBeforeInit":case"AppServicesInit":case"AppInit":case"ViewportVisibleInit":return}const i={originId:r??null,data:t??null};window.dispatchEvent(new CustomEvent(`${this.#A.uniqueId}_${e}`,{detail:i}))}#k(e,t){const r={originId:t||null};window.dispatchEvent(new CustomEvent(`${this.#A.uniqueId}_${e}`,{detail:r}))}#L(e,t,r){"AppInit"===e&&this.#M.appInitEventFired||"AppBeforeInit"===e&&this.#M.appBeforeInitEventFired?t(null,this.#A.uniqueId):window.addEventListener(`${this.#A.uniqueId}_${e}`,(e=>{const i=e.detail?.originId;i&&i!==r&&r||t(e.detail?.data,i??"anonymous")}))}#N(t,r,i){const n=(n,o)=>{this.#D?(this.#$.console("error",`🟥 ${t} (${e[r]}) REPORTED AN ERROR 🟥`),this.#$.console("error",n),o&&this.#$.console("error",o),i&&this.#H(i)):document.body.setAttribute("jsvh-error-has-occurred","yes"),this.#G({url:window.location.href,errorDetails:o,controllerType:r,uncontrolledError:!1},t)},o=(n,o,s)=>{const l=r===e.DOMInstanceController||r===e.DOMInstanceFunctionalController,a=(a,c)=>{this.#D&&this.#$.console("log",`🪃⬇️ ${t} (${e[r]}) has received the ${n}${s?` ~ ${s}`:""} event subscription. | ${(new Date).toISOString()}`);try{o(a,c),this.#D&&this.#$.console("log",`🪃✅ ${t} (${e[r]}) completed the ${n}${s?` ~ ${s}`:""} event subscription. | ${(new Date).toISOString()}`),this.#k(`${n}%`,t)}catch(e){this.#_(t,r,e,i??null),this.#k(`${n}/`,t),l&&this.#e.errorManagement?.hideCrashedDOMInstancesWhileRunning&&(i.style.display="none")}};"ViewportVisibleInit"===n&&l?this.#$.onViewportVisibleOnce((()=>{a(null,null)}),{root:null,rootMargin:"0px",threshold:.1},i):("AppServicesInit"===n&&r===e.Service&&this.#M.appServicesInitEventSubscribedControllers.add(t),this.#t.subscribe(n,((e,t)=>{a(e,t)}),s))},s=(i,n)=>{const s=i.reduce(((e,t)=>(e[t.appEventName]={...t,completed:!1,data:null,originId:""},e)),{}),l=()=>{const i=Object.values(s);if(i.reduce(((e,t)=>e&&t.completed),!0)){const o=i.flatMap((e=>e.data)),s=i.flatMap((e=>e.originId));n(o,s),this.#D&&this.#$.console("log",`🪃🪃✅ ${t} (${e[r]}) completed a multiple event subscription. | ${(new Date).toISOString()}`)}};i.forEach((e=>{o(e.appEventName,((t,r)=>{const i=s[e.appEventName];s[e.appEventName]={...i,completed:!0,data:t,originId:r},l()}),e.targetId)}))},l=i?()=>i:this.#t.getRootDOMElement;return{...this.#t,logOnDebug:(i,n=!0)=>{this.#D&&(this.#$.console("log",`⬇️ DEBUG LOG FROM: ${t} (${e[r]}) ⬇️`),this.#$.console("log",i),n&&console.trace(),this.#$.console("log","END OF DEBUG LOG"))},warnOnDebug:(i,n=!0)=>{this.#D&&(this.#$.console("warn",`⬇️ DEBUG WARN FROM: ${t} (${e[r]}) ⬇️`),this.#$.console("warn",i),n&&console.trace(),this.#$.console("warn","END OF DEBUG WARN"))},reportError:n,subscribe:o,subscribeToAll:s,getRootDOMElement:l,whoIam:()=>({aliasOrId:t,type:r}),emit:(e,r)=>{this.#B(e,r,t)},getContextVar:(e,r)=>{const i=this.#O[e];if(i){if(i.scope?.includes(t)||!i.scope)return r&&this.#t.subscribe(`ContextVarChange_${e}`,(()=>r(this.#O[e]?.value))),i.value;n(`Error accessing value of context var "${e}", is out of scope.`)}return null},setContextVar:(e,r,i,o)=>{const s=this.#O[e];if(s){if(!s.scope?.includes(t)&&s.scope)return void n(`Error setting value to context var "${e}", is out of scope.`);if(i&&s.creatorId!==t)return void n(`Error setting value to context var "${e}", is read only.`);this.#O[e].value=r}this.#O[e]={alias:e,value:r,readOnly:!!i,scope:o?[...t,...o]:null,creatorId:t},this.#k(`ContextVarChange_${e}`)},useVendor:(i,n,l="",a=!0)=>{if(l)if(a)o(l,(()=>{this.#t.getService("vendorLoader").requestVendorLoad(i,(()=>{this.#D&&this.#$.console("log",`🧱✅ ${t} (${e[r]}) used vendor "${i}" (combined init) | ${(new Date).toISOString()}`),n()}))}));else{s([{appEventName:`${i}VendorLoad`},{appEventName:l}],n);this.#t.getService("vendorLoader").requestVendorLoad(i)}else{this.#t.getService("vendorLoader").requestVendorLoad(i,(()=>{this.#D&&this.#$.console("log",`🧱✅ ${t} (${e[r]}) used vendor "${i}" | ${(new Date).toISOString()}`),n()}))}}}}#R(t,r){try{const i=new r(this.#N(t,e.SimpleController));this.#S[t]=i}catch(r){this.#_(t,e.SimpleController,r)}}#x(t,r){try{const i=r(this.#N(t,e.SimpleFunctionalController));this.#S[t]=i}catch(r){this.#_(t,e.SimpleFunctionalController,r)}}#_(t,r,i,n){this.#D?(this.#$.console("error",`🟥 ${t} (${e[r]}) THROWED AN UNCONTROLLED ERROR 🟥`),this.#$.console("error",i),this.#$.console("error","END OF UNCONTROLLED ERROR REPORT"),n&&this.#H(n)):document.body.setAttribute("jsvh-error-has-occurred","yes"),this.#G({url:window.location.href,errorDetails:i,controllerType:r,uncontrolledError:!0},t)}#z(t,r){try{const i=new r(this.#N(t,e.Service));this.#E[t]=i}catch(r){this.#_(t,e.Service,r)}}start(){this.#M.appInitTime||(this.#M.appInitTime=new Date,this.#D&&(console.log(`JSVanillaHelper AppArchitecture ${this.#C} is in verbose & debug mode 🧯`),console.log(`💽 ${this.#A.alias} | Unique ID [${this.#A.uniqueId}] | Build Number [${this.#A.buildNumber??"Unknown"}]`)),this.#k("AppBeforeInit"),this.#M.appBeforeInitEventFired=!0,this.#z("vendorLoader",t),this.#z("imageLoader",r),Object.values(this.#w).forEach((e=>{this.#z(e.uniqueAlias,e.serviceControllerClass)})),Object.values(this.#f).forEach((e=>{e.controllerClass&&!e.controllerFunction?this.#R(e.uniqueAlias,e.controllerClass):!e.controllerClass&&e.controllerFunction&&this.#x(e.uniqueAlias,e.controllerFunction)})),this.#U().then((()=>{this.#D&&this.#$.console("log","Services initialization completed ✅"),this.#T(),this.#k("AppInit"),this.#M.appInitEventFired=!0})).catch((e=>{console.error("AppArchitecture: Service controller error, cannot continue with app initialization."),this.#D&&console.error(e)})),this.#k("AppServicesInit"))}#G(e,t){window.dispatchEvent(new CustomEvent(`${this.#A.uniqueId}_AppError`,{detail:{originId:t||"self/unknown",errorData:e}}))}getService(e){const t=this.#E[e]??null;return t||console.error(`AppArchitecture: Service "${e}" not found/registered in app "${this.#A.uniqueId}"`),t}getController(e){const t=this.#S[e]??null;if(t){if(t?.createComponentInstance)return console.error("AppArchitecture: Instances controller cannot be accessed directly"),null}else console.error(`AppArchitecture: Controller "${e}" not found/registered in app "${this.#A.uniqueId}"`);return t}getInstanceControllerById(e){const t=this.#V[e]?.componentInstance??null;return t||console.error(`AppArchitecture: Instance controller for component "${e}" not found/registered in app "${this.#A.uniqueId}"`),t}getInstanceController(e){const t=e?.getAttribute("jsvh-component-id");return t?this.getInstanceControllerById(t):(console.error("AppArchitecture: DOM element does not have a valid component instance id"),null)}}class n{#j;#W;#J;#P;constructor(e,t,r){this.#P=0,this.#j=e,this.#W=t,this.#J=r}createComponentInstance(t,r){const i=t.id?t.id:`${this.#j.replace("Controller","")}-${this.#P}`;let n=null;if(this.#W){const o=r(i,e.DOMInstanceController,t);n=new this.#W(o)}else if(this.#J){const o=r(i,e.DOMInstanceFunctionalController,t);n=this.#J(o)}return{uniqueId:i,instancesControllerUniqueId:this.#j,componentInstance:n,rootDOMElement:t}}}const o=new class{extensionName;version;helper;constructor(){this.extensionName="AppArchitecture",this.version=4.04}extendHelperInstance(e){e.createApp=this.createApp.bind(this),e.toggleLSDebugModeSetting=this.toggleLSDebugModeSetting.bind(this),e.getApp=this.getApp.bind(this),e.getMainApp=this.getMainApp.bind(this)}toggleLSDebugModeSetting(){const e=!!localStorage.getItem("JSVHAppArchitectureDebug");e?localStorage.removeItem("JSVHAppArchitectureDebug"):localStorage.setItem("JSVHAppArchitectureDebug","true"),this.helper.console("log",`🧯 JSVanillaHelper AppArchitecture debug mode set to ${!e}, please refresh website.`)}createApp(e=!0){const{helper:t}=this,r=t.t;if(!t.isPlainObject(r))return void console.error("Target is not a valid Object");if(!r.config)return void console.error(`Cannot find "config" property, please check if app structure is suitable for JSVanillaHelper App Architecture ${this.version} .`);if(!r.id)return void console.error(`Cannot find "id" property, please check if app structure is suitable for JSVanillaHelper App Architecture ${this.version} .`);const n=new i(r,t);return e&&(t.hData.reg.mainAppRef=n),t.hData.reg[`${r.id.uniqueId}_AppRef`]=n,n}getApp(e){return this.helper.hData.reg[`${e}_AppRef`]??null}getMainApp(){return this.helper.hData.reg.mainAppRef??null}};module.exports=o;
