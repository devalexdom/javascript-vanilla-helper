"use strict";var e;!function(e){e[e.Unknown=0]="Unknown",e[e.SimpleController=1]="SimpleController",e[e.DOMInstanceController=2]="DOMInstanceController",e[e.EmbeddedInstancesController=3]="EmbeddedInstancesController",e[e.Service=4]="Service",e[e.SimpleFunctionalController=5]="SimpleFunctionalController",e[e.DOMInstanceFunctionalController=6]="DOMInstanceFunctionalController"}(e||(e={}));class t{#e;#t;constructor(e){this.#t=e,this.#e={vendors:[]};const t=e.getConfig("vendorLoader");if(t)this.#e={...this.#e,...t};else if(!1===t)return;e.subscribe("AppServicesInit",(()=>this.#r()))}#r(){this.#e.vendors.forEach((e=>{this.#i(e)}))}requestVendorLoad(e="",t=()=>{}){this.#e.vendors.forEach((r=>{r.triggerClass!==e||r.loaded?r.triggerClass===e&&r.loaded&&t():(r.requested=!0,this.#i(r),window.addEventListener(r.loadEventName,t))}))}#n(e){return e.conflictTriggerClass?.reduce(((e,t)=>e||document.getElementsByClassName(t).length>0),!1)??!1}#i(e){if(!this.#n(e)&&(document.getElementsByClassName(e.triggerClass).length>0||e.requested)){const{V:t}=this.#t,r=()=>{this.#t.getContextVar("isAppInDebugMode")&&t().console("log",`🧱 Vendor ${e.scriptPath} ${e.requested?"loaded by request.":"loaded by trigger CSS class."}`),t(window).dispatchEvent(e.loadEventName),e.loaded=!0};document.getElementById(`${e.triggerClass}-script`)||t(document.head).addScriptFile(e.scriptPath,r,`${e.triggerClass}-script`)}}}class r{#e;#o;#s;#t;constructor(e){this.#t=e,this.#s="",this.#e={loadImagesOnViewportVisible:!0,forceImageToHaveDomain:!0,viewportMobileSizes:["xs","sm"],viewportSizesMapping:()=>window.innerWidth<=575?"xs":window.innerWidth<=991?"sm":window.innerWidth<=1199?"md":window.innerWidth<=1399?"lg":"xl"};const t=e.getConfig("imageLoader");if(t)this.#e={...this.#e,...t};else if(!1===t)return;e.subscribe("AppServicesInit",(()=>this.#r()))}#r(){this.#l(),this.#c(),this.#e.loadImagesOnViewportVisible?this.#a():this.#p(),this.#h()}#p(){this.#o.forEach((e=>this.loadLazyElement(e)))}#a(){const{V:e}=this.#t;e(this.#o.filter((e=>!e.activeVisibilityTracking)).map((e=>(e.activeVisibilityTracking=!0,e)))).onViewportVisibleOnce((e=>{e.activeVisibilityTracking=!1,this.loadLazyElement(e)}))}#c(){this.#s=this.#u(),this.#t.setContextVar("viewportPredefinedSize",this.#s,!0),this.#t.setContextVar("isViewportSizeMobile",this.#e.viewportMobileSizes.includes(this.#s),!0)}#l(){this.#o=[...document.body.querySelectorAll("[data-image-src]")]}#d(e,t){return(this.#e.forceImageToHaveDomain?new URL(e,document.baseURI):new URL(e)).toString()}#g(e,t){if("xl"!==this.#s){const t=e.getAttribute(`data-src-${this.#s}`);if(t)return t}return t}#u(){return this.#e.viewportSizesMapping()}#I(e,t=e=>{}){let r=e;e.startsWith("/")&&(r=`${document.location.origin}${e}`),fetch(r).then((e=>e.text())).then((e=>{t(e)})).catch((t=>{console.error(`Cannot render SVG from ${e}`),console.error(t)}))}#m(e){const t=document.createElement("div");t.innerHTML=e;[...t.getElementsByTagName("script")].forEach((e=>{e.parentNode.removeChild(e)}));return t.getElementsByTagName("svg")[0]??null}#h(){const{V:e}=this.#t;e(window).onEvent("resize",(()=>{const e=this.#u();e!==this.#s&&(this.#s=e,this.#t.setContextVar("viewportPredefinedSize",this.#s,!0),this.#t.setContextVar("isViewportSizeMobile",this.#e.viewportMobileSizes.includes(this.#s),!0),this.#e.loadImagesOnViewportVisible?this.#a():this.#p())}))}loadLazyElement(e){const{V:t}=this.#t,r=e.getAttribute("data-image-src");if(!r)return void e.removeAttribute("data-image-src");const i=this.#d(this.#g(e,r),e);switch(e.tagName){case"IMG":e.setAttribute("src",i),t(e).hasClass("load-feedback")&&t(e).onEvent("load",(()=>{e.classList.add("img-loaded")}));break;case"DIV":(t(e).hasClass("parent-background-image")?e.parentNode:e).style.backgroundImage=`url("${i}")`;break;case"svg":this.#I(i,(t=>{const r=this.#m(t);if(r){const t=e.lazyloadCallback;if(!!!r.getAttribute("viewBox")){const e=r.getAttribute("height"),t=r.getAttribute("width");e&&t&&r.setAttribute("viewBox",`0 0 ${t} ${e}`)}e.classList.forEach((e=>{r.classList.add(e)})),e.parentNode.replaceChild(r,e),t&&t(r)}}));break;default:this.#t.reportError("Unsupported DOM element",e)}}}class i{#v;#b;#e;#C;#A;#S;#f;#w;#E;#t;#V;#D;#$;constructor(e,t){this.#v="4.0.1 beta",this.#b=e.id,this.#e=e.config,this.#E=t,this.#V=this.#M(),this.#t=this.#y(),this.#c(e),this.#f={},this.#A={},this.#S={},this.#C={},this.#w={},this.#D={appInitTime:null,appBeforeInitEventFired:!1,appInitEventFired:!1,appServicesInitEventSubscribedControllers:new Set,appServicesInitEventCompletedControllers:new Set},window.appTestOnly=this}debug(){return{services:this.#S,controllers:this.#C,data:this.#D}}getUniqueId(){return this.#b.uniqueId}getBuildNumber(){return this.#b.buildNumber}#c(e){const t={alias:"isAppInDebugMode",value:this.#V,readOnly:!0};this.#$=e.contextVars??{},this.#$[t.alias]=t}#y(){const t={getController:this.getController.bind(this),getCurrentCulture:this.getCulture.bind(this),getService:this.getService.bind(this),getInstanceController:this.getInstanceController.bind(this),getInstanceControllerById:this.getInstanceControllerById.bind(this),getConfig:this.getConfig.bind(this),V:(e=null)=>this.#E.setTarget(e),V$:(e=null)=>this.#E.setTarget(document.querySelectorAll(e)),logOnDebug:()=>{},warnOnDebug:()=>{},reportError:()=>{},whoIam:()=>({aliasOrId:"I don't know...",type:e.Unknown}),subscribe:this.#O.bind(this),emit:()=>{},getContextVar:()=>{},setContextVar:()=>{},getRootDOMElement:()=>document.documentElement};return this.#E.makeInmutable(t),t}#M(){return!!localStorage.getItem("JSVHAppArchitectureDebug")}getCulture(){return this.#e.culture??""}getConfig(e){return this.#e.custom[e]??null}registerSimpleController(e="",t,r){e&&t?this.#C[e]||this.#A[e]||this.#S[e]||this.#f[e]?console.error(`AppArchitecture: Unable to register controller, "${e}" is already registered.`):r?.generateInstanceBeforeInit?this.#x(e,t):this.#A[e]={uniqueAlias:e,controllerClass:t,controllerFunction:null}:console.error("AppArchitecture: Unable to register controller, unique alias and controllerClass are expected parameters.")}registerFunctionalSimpleController(e="",t,r){e&&t?this.#C[e]||this.#A[e]||this.#S[e]||this.#f[e]?console.error(`AppArchitecture: Unable to register controller, "${e}" is already registered.`):r?.generateInstanceBeforeInit?this.#z(e,t):this.#A[e]={uniqueAlias:e,controllerClass:null,controllerFunction:t}:console.error("AppArchitecture: Unable to register controller, unique alias and controllerFunction are expected parameters.")}registerService(e="",t,r){e&&t?this.#C[e]||this.#A[e]||this.#S[e]||this.#f[e]?console.error(`AppArchitecture: Unable to register service, "${e}" is already registered.`):this.#q(e,t):console.error("AppArchitecture: Unable to register service, unique alias and serviceControllerClass are expected parameters.")}registerInstancesController(e="",t,r){e&&t?this.#C[e]||this.#A[e]||this.#S[e]||this.#f[e]?console.error(`AppArchitecture: Unable to register instance controller, "${e}" is already registered.`):this.#C[e]=new n(e,t,null):console.error("AppArchitecture: Unable to register instance controller, unique alias and instanceControllerClass are expected parameters.")}registerFunctionalInstancesController(e="",t,r){e&&t?this.#C[e]||this.#A[e]||this.#S[e]||this.#f[e]?console.error(`AppArchitecture: Unable to register instance controller, "${e}" is already registered.`):this.#C[e]=new n(e,null,t):console.error("AppArchitecture: Unable to register instance controller, unique alias and instanceControllerFunction are expected parameters.")}#R(e,t){this.#E.console("error",`🤕 An unhandled error happened in the inline init of DOM instance component "${e.id?e.id:"-NO ID-"}"`),this.#E.console("error",e),this.#E.console("error",t||"Controller not found in main app"),(e=>{this.#V?(e.style.opacity=.6,e.style.filter="grayscale(100%)",e.prepend("⚠️")):this.#e.errorManagement?.hideCrashedDOMInstancesDuringInit&&(e.style.display="none")})(e)}#H(){const e=(e,t)=>{const r=t.createComponentInstance(e,this.#T.bind(this));this.#w[r.uniqueId]?this.#R(e,`DOM Instance id "${r.uniqueId}" not unique`):this.#w[r.uniqueId]=r};[...document.querySelectorAll("[jsvh-controller]")].forEach((t=>{const r=t.getAttribute("jsvh-controller"),i=t.getAttribute("jsvh-modular-controller-src");try{const n=this.#C[r];if(!n&&!i)return void this.#R(t);!n&&i?this.#E.addScriptFile(i,(()=>{const i=this.#C[r];i?e(t,i):this.#R(t)}),`${r}-script`,document.head):e(t,n)}catch(e){this.#R(t,e)}}))}#F(){return new Promise(((e,t)=>{0===this.#D.appServicesInitEventSubscribedControllers.size?e():(this.#O("AppServicesInit%",((t,r)=>{this.#S[r]&&(this.#D.appServicesInitEventCompletedControllers.add(r),this.#D.appServicesInitEventCompletedControllers.size===this.#D.appServicesInitEventSubscribedControllers.size&&e())})),this.#O("AppServicesInit/",((e,r)=>{this.#S[r]&&t()})))}))}#U(e,t,r){switch(e){case"AppPreInit":case"AppServicesInit":case"AppInit":case"ViewportVisibleInit":return}const i={originId:r??null,data:t??null};window.dispatchEvent(new CustomEvent(`${this.#b.uniqueId}_${e}`,{detail:i}))}#L(e,t){const r={originId:t||null};window.dispatchEvent(new CustomEvent(`${this.#b.uniqueId}_${e}`,{detail:r}))}#O(e,t,r){"AppInit"===e&&this.#D.appInitEventFired||"AppBeforeInit"===e&&this.#D.appBeforeInitEventFired?t(null,this.#b.uniqueId):window.addEventListener(`${this.#b.uniqueId}_${e}`,(e=>{const i=e.detail?.originId;i&&i!==r&&r||t(e.detail?.data,i??"anonymous")}))}#T(t,r,i){const n=(e,i)=>{this.#V?(this.#E.console("error",`🟥 ${t} (${r}) REPORTED AN ERROR 🟥`),this.#E.console("error",e),i&&this.#E.console("error",i),console.trace()):document.body.setAttribute("jsvh-error-has-occurred","yes"),this.#B({url:window.location.href,errorDetails:i,controllerType:r,uncontrolledError:!1},t)},o=i?()=>i:this.#t.getRootDOMElement;return{...this.#t,logOnDebug:e=>{this.#V&&(this.#E.console("log",`⬇️ DEBUG FROM: ${t} (${r}) ⬇️`),this.#E.console("log",e),console.trace())},warnOnDebug:e=>{this.#V&&(this.#E.console("warn",`⬇️ DEBUG WARN FROM: ${t} (${r}) ⬇️`),this.#E.console("warn",e),console.trace())},reportError:n,subscribe:(n,o,s)=>{const l=r===e.DOMInstanceController||r===e.DOMInstanceFunctionalController,c=(c,a)=>{this.#V&&this.#E.console("log",`🪃⬇️ ${t} (${e[r]}) has received the ${n}${s?` ~ ${s}`:""} subscription. | ${(new Date).toISOString()}`);try{o(c,a),this.#V&&this.#E.console("log",`🪃✅ ${t} (${e[r]}) completed the ${n}${s?` ~ ${s}`:""} subscription. | ${(new Date).toISOString()}`),this.#L(`${n}%`,t)}catch(e){this.#k(t,r,e),this.#L(`${n}/`,t),l&&this.#e.errorManagement?.hideCrashedDOMInstancesWhileRunning&&(i.style.display="none")}};"ViewportVisibleInit"===n&&l?this.#E.onViewportVisibleOnce((()=>{c(null,null)}),{root:null,rootMargin:"0px",threshold:1},i):("AppServicesInit"===n&&r===e.Service&&this.#D.appServicesInitEventSubscribedControllers.add(t),this.#t.subscribe(n,((e,t)=>{c(e,t)}),s))},getRootDOMElement:o,whoIam:()=>({aliasOrId:t,type:r}),emit:(e,r)=>{this.#U(e,r,t)},getContextVar:(e,r)=>{const i=this.#$[e];if(i){if(i.scope?.includes(t)||!i.scope)return r&&this.#t.subscribe(`ContextVarChange_${e}`,(()=>r(this.#$[e]?.value))),i.value;n(`Error accessing value of context var "${e}", is out of scope.`)}return null},setContextVar:(e,r,i,o)=>{const s=this.#$[e];if(s){if(!s.scope?.includes(t)&&s.scope)return void n(`Error setting value to context var "${e}", is out of scope.`);if(i&&s.creatorId!==t)return void n(`Error setting value to context var "${e}", is read only.`);this.#$[e].value=r}this.#$[e]={alias:e,value:r,readOnly:!!i,scope:o?[...t,...o]:null},this.#L(`ContextVarChange_${e}`)}}}#x(t,r){try{const i=new r(this.#T(t,e.SimpleController));this.#C[t]=i}catch(r){this.#k(t,e.SimpleController,r)}}#z(t,r){try{const i=r(this.#T(t,e.SimpleFunctionalController));this.#C[t]=i}catch(r){this.#k(t,e.SimpleFunctionalController,r)}}#k(e,t,r){this.#V?(this.#E.console("error",`🟥 ${e} (${t}) THROWED AN UNCONTROLLED ERROR 🟥`),this.#E.console("error",r)):document.body.setAttribute("jsvh-error-has-occurred","yes"),this.#B({url:window.location.href,errorDetails:r,controllerType:t,uncontrolledError:!0},e)}#q(t,r){try{const i=new r(this.#T(t,e.Service));this.#S[t]=i}catch(r){this.#k(t,e.Service,r)}}start(){this.#D.appInitTime||(this.#D.appInitTime=new Date,this.#V&&(console.log(`JSVanillaHelper APP Architecture ${this.#v} is in verbose & debug mode 🧯`),console.log(`💽 ${this.#b.alias} | Unique ID [${this.#b.uniqueId}] | Build Number [${this.#b.buildNumber??"Unknown"}]`)),this.#L("AppBeforeInit"),this.#D.appBeforeInitEventFired=!0,this.#q("vendorLoader",t),this.#q("imageLoader",r),Object.values(this.#f).forEach((e=>{this.#q(e.uniqueAlias,e.serviceControllerClass)})),Object.values(this.#A).forEach((e=>{e.controllerClass&&!e.controllerFunction?this.#x(e.uniqueAlias,e.controllerClass):!e.controllerClass&&e.controllerFunction&&this.#z(e.uniqueAlias,e.controllerFunction)})),this.#F().then((()=>{this.#E.console("log","Services initialization completed ✅"),this.#H(),this.#L("AppInit"),this.#D.appInitEventFired=!0})).catch((e=>{console.error("AppArchitecture: Service controller error, cannot continue with app initialization."),this.#V&&console.error(e)})),this.#L("AppServicesInit"))}#B(e,t){window.dispatchEvent(new CustomEvent(`${this.#b.uniqueId}_AppError`,{detail:{originId:t||"self/unknown",errorData:e}}))}getService(e){const t=this.#S[e]??null;return t||console.error(`AppArchitecture: Service "${e}" not found/registered in app "${this.#b.uniqueId}"`),t}getController(e){const t=this.#C[e]??null;if(t){if(t?.createComponentInstance)return console.error("AppArchitecture: Instances controller cannot be accessed directly"),null}else console.error(`AppArchitecture: Controller "${e}" not found/registered in app "${this.#b.uniqueId}"`);return t}getInstanceControllerById(e){const t=this.#w[e]?.componentInstance??null;return t||console.error(`AppArchitecture: Instance controller for component "${e}" not found/registered in app "${this.#b.uniqueId}"`),t}getInstanceController(e){const t=e?.getAttribute("jsvh-component-id");return t?this.getInstanceControllerById(t):(console.error("AppArchitecture: DOM element does not have a valid component instance id"),null)}}class n{#N;#j;#P;#G;constructor(e,t,r){this.#G=0,this.#N=e,this.#j=t,this.#P=r}createComponentInstance(t,r){const i=t.id?t.id:`${this.#N.replace("Controller","")}-${this.#G}`;let n=null;if(this.#j){const o=r(i,e.DOMInstanceController,t);n=new this.#j(o)}else if(this.#P){const o=r(i,e.DOMInstanceFunctionalController,t);n=this.#P(o)}return{uniqueId:i,instancesControllerUniqueId:this.#N,componentInstance:n,rootDOMElement:t}}}const o=new class{extensionName;version;helper;constructor(){this.extensionName="AppArchitecture",this.version=4.01}extendHelperInstance(e){e.createApp=this.createApp.bind(this),e.toggleLSDebugModeSetting=this.toggleLSDebugModeSetting.bind(this),e.getApp=this.getApp.bind(this),e.getMainApp=this.getMainApp.bind(this)}toggleLSDebugModeSetting(){const e=!!localStorage.getItem("JSVHAppArchitectureDebug");e?localStorage.removeItem("JSVHAppArchitectureDebug"):localStorage.setItem("JSVHAppArchitectureDebug","true"),this.helper.console("log",`🧯 JSVanillaHelper AppArchitecture debug mode set to ${!e}, please refresh website.`)}createApp(e=!0){const{helper:t}=this,r=t.t;if(!t.isPlainObject(r))return void console.error("Target is not a valid Object");if(!r.config)return void console.error(`Cannot find "config" property, please check if app structure is suitable for JSVanillaHelper App Architecture ${this.version} .`);if(!r.id)return void console.error(`Cannot find "id" property, please check if app structure is suitable for JSVanillaHelper App Architecture ${this.version} .`);const n=new i(r,t);return e&&(t.hData.reg.mainAppRef=n),t.hData.reg[`${r.id.uniqueId}_AppRef`]=n,n}getApp(e){return this.helper.hData.reg[`${e}_AppRef`]??null}getMainApp(){return this.helper.hData.reg.mainAppRef??null}};module.exports=o;
