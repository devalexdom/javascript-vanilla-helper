"use strict";var e;!function(e){e[e.Unknown=0]="Unknown",e[e.SimpleController=1]="SimpleController",e[e.DOMInstanceController=2]="DOMInstanceController",e[e.EmbeddedInstancesController=3]="EmbeddedInstancesController",e[e.Service=4]="Service",e[e.SimpleFunctionalController=5]="SimpleFunctionalController",e[e.DOMInstanceFunctionalController=6]="DOMInstanceFunctionalController"}(e||(e={}));class t{#e;#t;#r;constructor(e){this.#t=e,this.#e={vendors:[]},this.#r={};const t=e.getConfig("vendorLoader");if(t)this.#e={...this.#e,...t};else if(!1===t)return;e.subscribe("AppServicesInit",(()=>this.#i()))}#i(){this.#r=this.#e.vendors.reduce(((e,t)=>(e[t.uniqueName]={...t,requested:!1,loaded:!1},e)),{}),this.#e.vendors.forEach((e=>{this.#n(e)}))}requestVendorLoad(e,t=()=>{}){const r=this.#r[e];r?r.loaded?t():(r.requested=!0,this.#n(r),window.addEventListener(r.loadEventName??`VendorLoader_${e}_Load`,t)):this.#t.reportError(`No vendor with unique name "${e}" found.`,null)}#o(e){return e.conflictTriggerClass?.reduce(((e,t)=>e||document.getElementsByClassName(t).length>0),!1)??!1}#n(e){if(!this.#o(e)&&(document.getElementsByClassName(e.triggerClass).length>0||e.requested)){const{V:t}=this.#t,r=()=>{this.#t.logOnDebug(`🧱 Vendor ${e.scriptPath} ${e.requested?"loaded by request.":"loaded by trigger CSS class."}`,!1),this.#t.emit(`${e.uniqueName}VendorLoad`),t(window).dispatchEvent(e.loadEventName??`VendorLoader_${e.uniqueName}_Load`),e.loaded=!0};document.getElementById(`${e.triggerClass}-script`)||t(document.head).addScriptFile(e.scriptPath,r,`${e.triggerClass}-script`)}}}class r{#e;#s;#l;#t;constructor(e){this.#t=e,this.#l="",this.#e={loadImagesOnViewportVisible:!0,forceImageToHaveDomain:!0,viewportMobileSizes:["xs","sm"],viewportSizesMapping:()=>window.innerWidth<=575?"xs":window.innerWidth<=991?"sm":window.innerWidth<=1199?"md":window.innerWidth<=1399?"lg":"xl"};const t=e.getConfig("imageLoader");if(t)this.#e={...this.#e,...t};else if(!1===t)return;e.subscribe("AppServicesInit",(()=>this.#i()))}#i(){this.#c(),this.#a(),this.#e.loadImagesOnViewportVisible?this.#p():this.#h(),this.#d()}#h(){this.#s.forEach((e=>this.loadLazyElement(e)))}#p(){const{V:e}=this.#t;e(this.#s.filter((e=>!e.activeVisibilityTracking)).map((e=>(e.activeVisibilityTracking=!0,e)))).onViewportVisibleOnce((e=>{e.activeVisibilityTracking=!1,this.loadLazyElement(e)}),{root:null,rootMargin:"0px",threshold:.1})}#a(){this.#l=this.#u(),this.#t.setContextVar("viewportPredefinedSize",this.#l,!0),this.#t.setContextVar("isViewportSizeMobile",this.#e.viewportMobileSizes.includes(this.#l),!0)}#c(){this.#s=[...document.body.querySelectorAll("[data-image-src]")]}#g(e,t){return(this.#e.forceImageToHaveDomain?new URL(e,document.baseURI):new URL(e)).toString()}#m(e,t){if("xl"!==this.#l){const t=e.getAttribute(`data-src-${this.#l}`);if(t)return t}return t}#u(){return this.#e.viewportSizesMapping()}#v(e,t=e=>{}){let r=e;e.startsWith("/")&&(r=`${document.location.origin}${e}`),fetch(r).then((e=>e.text())).then((e=>{t(e)})).catch((t=>{console.error(`Cannot render SVG from ${e}`),console.error(t)}))}#I(e){const t=document.createElement("div");t.innerHTML=e;[...t.getElementsByTagName("script")].forEach((e=>{e.parentNode.removeChild(e)}));return t.getElementsByTagName("svg")[0]??null}#d(){const{V:e}=this.#t;e(window).onEvent("resize",(()=>{const e=this.#u();e!==this.#l&&(this.#l=e,this.#t.setContextVar("viewportPredefinedSize",this.#l,!0),this.#t.setContextVar("isViewportSizeMobile",this.#e.viewportMobileSizes.includes(this.#l),!0),this.#e.loadImagesOnViewportVisible?this.#p():this.#h())}))}loadLazyElement(e){const{V:t}=this.#t,r=e.getAttribute("data-image-src");if(!r)return void e.removeAttribute("data-image-src");const i=this.#g(this.#m(e,r),e);switch(e.tagName){case"IMG":e.setAttribute("src",i),t(e).hasClass("load-feedback")&&t(e).onEvent("load",(()=>{e.classList.add("img-loaded")}));break;case"DIV":(t(e).hasClass("parent-background-image")?e.parentNode:e).style.backgroundImage=`url("${i}")`;break;case"svg":this.#v(i,(t=>{const r=this.#I(t);if(r){const t=e.lazyloadCallback;if(!!!r.getAttribute("viewBox")){const e=r.getAttribute("height"),t=r.getAttribute("width");e&&t&&r.setAttribute("viewBox",`0 0 ${t} ${e}`)}e.classList.forEach((e=>{r.classList.add(e)})),e.parentNode.replaceChild(r,e),t&&t(r)}}));break;default:this.#t.reportError("Unsupported DOM element",e)}}}class i{#b;#C;#e;#A;#S;#f;#E;#w;#V;#t;#$;#D;#M;constructor(e,t){this.#b="4.0.3 beta",this.#C=e.id,this.#e=e.config,this.#V=t,this.#$=this.#O(),this.#t=this.#y(),this.#a(e),this.#E={},this.#S={},this.#f={},this.#A={},this.#w={},this.#D={appInitTime:null,appBeforeInitEventFired:!1,appInitEventFired:!1,appServicesInitEventSubscribedControllers:new Set,appServicesInitEventCompletedControllers:new Set}}debug(){return{services:this.#f,controllers:this.#A,data:this.#D}}getUniqueId(){return this.#C.uniqueId}getBuildNumber(){return this.#C.buildNumber}#a(e){const t={alias:"isAppInDebugMode",value:this.#$,readOnly:!0};this.#M=e.contextVars??{},this.#M[t.alias]=t}#y(){const t={getController:this.getController.bind(this),getCurrentCulture:this.getCulture.bind(this),getService:this.getService.bind(this),getInstanceController:this.getInstanceController.bind(this),getInstanceControllerById:this.getInstanceControllerById.bind(this),getConfig:this.getConfig.bind(this),V:(e=null)=>this.#V.setTarget(e),V$:(e=null)=>this.#V.setTarget(document.querySelectorAll(e)),logOnDebug:()=>{},warnOnDebug:()=>{},reportError:()=>{},whoIam:()=>({aliasOrId:"I don't know...",type:e.Unknown}),subscribe:this.#q.bind(this),subscribeToAll:()=>{},useVendor:()=>{},emit:()=>{},getContextVar:()=>{},setContextVar:()=>{},getRootDOMElement:()=>document.documentElement};return this.#V.makeInmutable(t),t}#O(){return!!localStorage.getItem("JSVHAppArchitectureDebug")}getCulture(){return this.#e.culture??""}getConfig(e){return this.#e.custom[e]??null}registerSimpleController(e="",t,r){e&&t?this.#A[e]||this.#S[e]||this.#f[e]||this.#E[e]?console.error(`AppArchitecture: Unable to register controller, "${e}" is already registered.`):r?.generateInstanceBeforeInit?this.#R(e,t):this.#S[e]={uniqueAlias:e,controllerClass:t,controllerFunction:null}:console.error("AppArchitecture: Unable to register controller, unique alias and controllerClass are expected parameters.")}registerFunctionalSimpleController(e="",t,r){e&&t?this.#A[e]||this.#S[e]||this.#f[e]||this.#E[e]?console.error(`AppArchitecture: Unable to register controller, "${e}" is already registered.`):r?.generateInstanceBeforeInit?this.#x(e,t):this.#S[e]={uniqueAlias:e,controllerClass:null,controllerFunction:t}:console.error("AppArchitecture: Unable to register controller, unique alias and controllerFunction are expected parameters.")}registerService(e="",t,r){e&&t?this.#A[e]||this.#S[e]||this.#f[e]||this.#E[e]?console.error(`AppArchitecture: Unable to register service, "${e}" is already registered.`):this.#L(e,t):console.error("AppArchitecture: Unable to register service, unique alias and serviceControllerClass are expected parameters.")}registerInstancesController(e="",t,r){e&&t?this.#A[e]||this.#S[e]||this.#f[e]||this.#E[e]?console.error(`AppArchitecture: Unable to register instances controller, "${e}" is already registered.`):this.#A[e]=new n(e,t,null):console.error("AppArchitecture: Unable to register instances controller, unique alias and instanceControllerClass are expected parameters.")}registerFunctionalInstancesController(e="",t,r){e&&t?this.#A[e]||this.#S[e]||this.#f[e]||this.#E[e]?console.error(`AppArchitecture: Unable to register instances controller, "${e}" is already registered.`):this.#A[e]=new n(e,null,t):console.error("AppArchitecture: Unable to register instances controller, unique alias and instanceControllerFunction are expected parameters.")}#H(e){this.#$?(e.style.opacity="0.6",e.style.filter="grayscale(100%)",e.prepend("⚠️")):this.#e.errorManagement?.hideCrashedDOMInstancesDuringInit&&(e.style.display="none")}#z(e,t){this.#V.console("error",`AppArchitecture: 🤕 An unexpected error happened in the inline init of DOM instance component "${e.id?e.id:"-NO ID-"}"`),this.#V.console("error",e),this.#V.console("error",t),this.#H(e)}#F(){const e=(e,t)=>{const r=t.createComponentInstance(e,this.#T.bind(this));this.#w[r.uniqueId]?this.#z(e,`DOM Instance id "${r.uniqueId}" is not unique.`):this.#w[r.uniqueId]=r};[...document.querySelectorAll("[jsvh-controller]")].forEach((t=>{const r=t.getAttribute("jsvh-controller"),i=t.getAttribute("jsvh-modular-controller-src"),n=this.#A[r];if(!n&&!i)return this.#V.console("error",`AppArchitecture: Instances controller "${r}" is not registered in the webapp.`),void this.#V.console("error",t);if(!n&&i)try{this.#V.addScriptFile(i,(()=>{const i=this.#A[r];if(!i)return this.#V.console("error",`AppArchitecture: Modular instances controller "${r}" is not registered in the webapp.`),void this.#V.console("error",t);e(t,i)}),`${r}-script`,document.head)}catch(e){this.#z(t,e)}else e(t,n)}))}#N(){return new Promise(((e,t)=>{0===this.#D.appServicesInitEventSubscribedControllers.size?e():(this.#q("AppServicesInit%",((t,r)=>{this.#f[r]&&(this.#D.appServicesInitEventCompletedControllers.add(r),this.#D.appServicesInitEventCompletedControllers.size===this.#D.appServicesInitEventSubscribedControllers.size&&e())})),this.#q("AppServicesInit/",((e,r)=>{this.#f[r]&&t()})))}))}#U(e,t,r){switch(e){case"AppBeforeInit":case"AppServicesInit":case"AppInit":case"ViewportVisibleInit":return}const i={originId:r??null,data:t??null};window.dispatchEvent(new CustomEvent(`${this.#C.uniqueId}_${e}`,{detail:i}))}#B(e,t){const r={originId:t||null};window.dispatchEvent(new CustomEvent(`${this.#C.uniqueId}_${e}`,{detail:r}))}#q(e,t,r){"AppInit"===e&&this.#D.appInitEventFired||"AppBeforeInit"===e&&this.#D.appBeforeInitEventFired?t(null,this.#C.uniqueId):window.addEventListener(`${this.#C.uniqueId}_${e}`,(e=>{const i=e.detail?.originId;i&&i!==r&&r||t(e.detail?.data,i??"anonymous")}))}#T(t,r,i){const n=(n,o)=>{this.#$?(this.#V.console("error",`🟥 ${t} (${e[r]}) REPORTED AN ERROR 🟥`),this.#V.console("error",n),o&&this.#V.console("error",o),i&&this.#H(i)):document.body.setAttribute("jsvh-error-has-occurred","yes"),this.#k({url:window.location.href,errorDetails:o,controllerType:r,uncontrolledError:!1},t)},o=(n,o,s)=>{const l=r===e.DOMInstanceController||r===e.DOMInstanceFunctionalController,c=(c,a)=>{this.#$&&this.#V.console("log",`🪃⬇️ ${t} (${e[r]}) has received the ${n}${s?` ~ ${s}`:""} event subscription. | ${(new Date).toISOString()}`);try{o(c,a),this.#$&&this.#V.console("log",`🪃✅ ${t} (${e[r]}) completed the ${n}${s?` ~ ${s}`:""} event subscription. | ${(new Date).toISOString()}`),this.#B(`${n}%`,t)}catch(e){this.#G(t,r,e,i??null),this.#B(`${n}/`,t),l&&this.#e.errorManagement?.hideCrashedDOMInstancesWhileRunning&&(i.style.display="none")}};"ViewportVisibleInit"===n&&l?this.#V.onViewportVisibleOnce((()=>{c(null,null)}),{root:null,rootMargin:"0px",threshold:.1},i):("AppServicesInit"===n&&r===e.Service&&this.#D.appServicesInitEventSubscribedControllers.add(t),this.#t.subscribe(n,((e,t)=>{c(e,t)}),s))},s=(i,n)=>{const s=i.reduce(((e,t)=>(e[t.appEventName]={...t,completed:!1,data:null,originId:""},e)),{}),l=()=>{const i=Object.values(s);if(i.reduce(((e,t)=>e&&t.completed),!0)){const o=i.flatMap((e=>e.data)),s=i.flatMap((e=>e.originId));n(o,s),this.#$&&this.#V.console("log",`🪃🪃✅ ${t} (${e[r]}) completed a multiple event subscription. | ${(new Date).toISOString()}`)}};i.forEach((e=>{o(e.appEventName,((t,r)=>{const i=s[e.appEventName];s[e.appEventName]={...i,completed:!0,data:t,originId:r},l()}),e.targetId)}))},l=i?()=>i:this.#t.getRootDOMElement;return{...this.#t,logOnDebug:(i,n=!0)=>{this.#$&&(this.#V.console("log",`⬇️ DEBUG LOG FROM: ${t} (${e[r]}) ⬇️`),this.#V.console("log",i),n&&console.trace(),this.#V.console("log","END OF DEBUG LOG"))},warnOnDebug:(i,n=!0)=>{this.#$&&(this.#V.console("warn",`⬇️ DEBUG WARN FROM: ${t} (${e[r]}) ⬇️`),this.#V.console("warn",i),n&&console.trace(),this.#V.console("warn","END OF DEBUG WARN"))},reportError:n,subscribe:o,subscribeToAll:s,getRootDOMElement:l,whoIam:()=>({aliasOrId:t,type:r}),emit:(e,r)=>{this.#U(e,r,t)},getContextVar:(e,r)=>{const i=this.#M[e];if(i){if(i.scope?.includes(t)||!i.scope)return r&&this.#t.subscribe(`ContextVarChange_${e}`,(()=>r(this.#M[e]?.value))),i.value;n(`Error accessing value of context var "${e}", is out of scope.`)}return null},setContextVar:(e,r,i,o)=>{const s=this.#M[e];if(s){if(!s.scope?.includes(t)&&s.scope)return void n(`Error setting value to context var "${e}", is out of scope.`);if(i&&s.creatorId!==t)return void n(`Error setting value to context var "${e}", is read only.`);this.#M[e].value=r}this.#M[e]={alias:e,value:r,readOnly:!!i,scope:o?[...t,...o]:null,creatorId:t},this.#B(`ContextVarChange_${e}`)},useVendor:(i,n,l="",c=!0)=>{if(l)if(c)o(l,(()=>{this.#t.getService("vendorLoader").requestVendorLoad(i,(()=>{this.#$&&this.#V.console("log",`🧱✅ ${t} (${e[r]}) used vendor "${i}" (combined init) | ${(new Date).toISOString()}`),n()}))}));else{s([{appEventName:`${i}VendorLoad`},{appEventName:l}],n);this.#t.getService("vendorLoader").requestVendorLoad(i)}else{this.#t.getService("vendorLoader").requestVendorLoad(i,(()=>{this.#$&&this.#V.console("log",`🧱✅ ${t} (${e[r]}) used vendor "${i}" | ${(new Date).toISOString()}`),n()}))}}}}#R(t,r){try{const i=new r(this.#T(t,e.SimpleController));this.#A[t]=i}catch(r){this.#G(t,e.SimpleController,r)}}#x(t,r){try{const i=r(this.#T(t,e.SimpleFunctionalController));this.#A[t]=i}catch(r){this.#G(t,e.SimpleFunctionalController,r)}}#G(t,r,i,n){this.#$?(this.#V.console("error",`🟥 ${t} (${e[r]}) THROWED AN UNCONTROLLED ERROR 🟥`),this.#V.console("error",i),this.#V.console("error","END OF UNCONTROLLED ERROR REPORT"),n&&this.#H(n)):document.body.setAttribute("jsvh-error-has-occurred","yes"),this.#k({url:window.location.href,errorDetails:i,controllerType:r,uncontrolledError:!0},t)}#L(t,r){try{const i=new r(this.#T(t,e.Service));this.#f[t]=i}catch(r){this.#G(t,e.Service,r)}}start(){this.#D.appInitTime||(this.#D.appInitTime=new Date,this.#$&&(console.log(`JSVanillaHelper AppArchitecture ${this.#b} is in verbose & debug mode 🧯`),console.log(`💽 ${this.#C.alias} | Unique ID [${this.#C.uniqueId}] | Build Number [${this.#C.buildNumber??"Unknown"}]`)),this.#B("AppBeforeInit"),this.#D.appBeforeInitEventFired=!0,this.#L("vendorLoader",t),this.#L("imageLoader",r),Object.values(this.#E).forEach((e=>{this.#L(e.uniqueAlias,e.serviceControllerClass)})),Object.values(this.#S).forEach((e=>{e.controllerClass&&!e.controllerFunction?this.#R(e.uniqueAlias,e.controllerClass):!e.controllerClass&&e.controllerFunction&&this.#x(e.uniqueAlias,e.controllerFunction)})),this.#N().then((()=>{this.#$&&this.#V.console("log","Services initialization completed ✅"),this.#F(),this.#B("AppInit"),this.#D.appInitEventFired=!0})).catch((e=>{console.error("AppArchitecture: Service controller error, cannot continue with app initialization."),this.#$&&console.error(e)})),this.#B("AppServicesInit"))}#k(e,t){window.dispatchEvent(new CustomEvent(`${this.#C.uniqueId}_AppError`,{detail:{originId:t||"self/unknown",errorData:e}}))}getService(e){const t=this.#f[e]??null;return t||console.error(`AppArchitecture: Service "${e}" not found/registered in app "${this.#C.uniqueId}"`),t}getController(e){const t=this.#A[e]??null;if(t){if(t?.createComponentInstance)return console.error("AppArchitecture: Instances controller cannot be accessed directly"),null}else console.error(`AppArchitecture: Controller "${e}" not found/registered in app "${this.#C.uniqueId}"`);return t}getInstanceControllerById(e){const t=this.#w[e]?.componentInstance??null;return t||console.error(`AppArchitecture: Instance controller for component "${e}" not found/registered in app "${this.#C.uniqueId}"`),t}getInstanceController(e){const t=e?.getAttribute("jsvh-component-id");return t?this.getInstanceControllerById(t):(console.error("AppArchitecture: DOM element does not have a valid component instance id"),null)}}class n{#_;#j;#W;#J;constructor(e,t,r){this.#J=0,this.#_=e,this.#j=t,this.#W=r}createComponentInstance(t,r){const i=t.id?t.id:`${this.#_.replace("Controller","")}-${this.#J}`;let n=null;if(this.#j){const o=r(i,e.DOMInstanceController,t);n=new this.#j(o)}else if(this.#W){const o=r(i,e.DOMInstanceFunctionalController,t);n=this.#W(o)}return{uniqueId:i,instancesControllerUniqueId:this.#_,componentInstance:n,rootDOMElement:t}}}const o=new class{extensionName;version;helper;constructor(){this.extensionName="AppArchitecture",this.version=4.03}extendHelperInstance(e){e.createApp=this.createApp.bind(this),e.toggleLSDebugModeSetting=this.toggleLSDebugModeSetting.bind(this),e.getApp=this.getApp.bind(this),e.getMainApp=this.getMainApp.bind(this)}toggleLSDebugModeSetting(){const e=!!localStorage.getItem("JSVHAppArchitectureDebug");e?localStorage.removeItem("JSVHAppArchitectureDebug"):localStorage.setItem("JSVHAppArchitectureDebug","true"),this.helper.console("log",`🧯 JSVanillaHelper AppArchitecture debug mode set to ${!e}, please refresh website.`)}createApp(e=!0){const{helper:t}=this,r=t.t;if(!t.isPlainObject(r))return void console.error("Target is not a valid Object");if(!r.config)return void console.error(`Cannot find "config" property, please check if app structure is suitable for JSVanillaHelper App Architecture ${this.version} .`);if(!r.id)return void console.error(`Cannot find "id" property, please check if app structure is suitable for JSVanillaHelper App Architecture ${this.version} .`);const n=new i(r,t);return e&&(t.hData.reg.mainAppRef=n),t.hData.reg[`${r.id.uniqueId}_AppRef`]=n,n}getApp(e){return this.helper.hData.reg[`${e}_AppRef`]??null}getMainApp(){return this.helper.hData.reg.mainAppRef??null}};module.exports=o;
